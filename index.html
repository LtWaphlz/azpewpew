<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Demo Dashboard Attack Map</title>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<style>
  body { margin:0; padding:0; background:#000; color:#fff; }

  #titlediv{
    font-family: monospace; text-align:center; font-size:48px;
    position:fixed; width:100%; height:50px; color:#fff; background:#000;
    padding:5px; top:0; z-index:10; overflow-y:auto;
  }

  /* Simple toolbar (does not touch map internals) */
  #toolbar{
    position:fixed; left:0; right:0; top:55px; z-index:11;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:8px 10px; background:rgba(0,0,0,.85); border-bottom:1px solid #222;
    font-family: monospace; font-size:13px;
  }
  #toolbar button{
    cursor:pointer; background:#111; color:#eee; border:1px solid #333;
    padding:6px 10px; border-radius:6px;
  }
  #toolbar button:hover{ background:#151515; }

  #container1{ position:relative; width:100vw; height:100vh; max-width:100%; max-height:100%; }

  #attackdiv{
    font-family: monospace; font-size:10px;
    position:fixed; width:50%; height:110px; color:#fff; background:#000;
    padding:5px; bottom:0; z-index:10; overflow-y:auto; border-top:1px solid #222;
  }

  /* Fixed legend (never cut off by the log) */
  #legendBox{
    position:fixed; left:10px; bottom:130px; z-index:12;
    background:rgba(0,0,0,.85); border:1px solid #333; border-radius:6px;
    padding:6px 8px; color:#ddd; font-family:monospace; font-size:11px;
  }
  #legendBox .sw{ display:inline-block; width:12px; height:6px; border-radius:1px; margin-right:6px; }

  /* Hover tooltip for arcs */
  #tooltip{
    position:fixed; z-index:20; display:none; pointer-events:none;
    background:rgba(20,20,20,0.95); color:#eaeaea; border:1px solid #333; border-radius:6px;
    padding:8px 10px; font-family:monospace; font-size:11px; max-width:260px; line-height:1.35;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #tooltip .ttl{ font-weight:bold; color:#9fdcff; }

  #about{ display:none; }
  #aboutdiv{ text-align:right; width:100px; height:100px; top:0; right:0; position:fixed; padding:10px; color:#fff; z-index:12; }
  #ccdiv{ text-align:right; width:100px; height:20px; bottom:0; right:0; position:fixed; padding:5px; color:#fff; z-index:12; }

  /* SimpleModal defaults (unchanged) */
  #simplemodal-overlay { background-color:#000; }
  #simplemodal-container {height:460px; width:600px; color:#bbb; background:#333; border:4px solid #444; padding:12px;}
  #simplemodal-container .simplemodal-data {padding:8px;}
  #simplemodal-container code {background:#141414; border-left:3px solid #65B43D; color:#bbb; display:block; font-size:12px; margin-bottom:12px; padding:4px 6px 6px;}
  #simplemodal-container a {color:#ddd;}
  #simplemodal-container a.modalCloseImg {background:url(x.png) no-repeat; width:25px; height:29px; display:inline; z-index:3200; position:absolute; top:-15px; right:-18px; cursor:pointer;}
  #simplemodal-container h3 {color:#84b8d9;}
</style>

<!-- Original libs -->
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="jquery.simplemodal-1.4.4.js"></script>

<script>
  function about(){ $("#about").modal(); }

  // URL helpers used by the buttons
  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function setParams(obj){
    const url = new URL(window.location.href);
    Object.keys(obj).forEach(k=>{
      const v = obj[k];
      if (v===null||v===undefined||v==='') url.searchParams.delete(k);
      else url.searchParams.set(k,v);
    });
    window.location.href = url.toString();
  }
</script>
</head>

<body>
  <!-- sounds -->
  <audio id="starwars" src="Blaster-Solo.wav" preload="auto"></audio>
  <audio id="tng" src="tng_torpedo_clean.mp3" preload="auto"></audio>
  <audio id="b5" src="B5-interceptor1.wav" preload="auto"></audio>
  <audio id="wargames" src="WarGames-KeyPress.wav" preload="auto"></audio>
  <audio id="pew" src="pew.mp3" preload="auto"></audio>
  <audio id="galaga" src="shot_sound.mp3" preload="auto"></audio>
  <audio id="asteroids" src="asteroids.mp3" preload="auto"></audio>
  <audio id="china" src="china.mp3" preload="auto"></audio>
  <audio id="timallen" src="timallen.wav" preload="auto"></audio>

  <div id="titlediv">Demo Dashboard Attack Map</div>

  <!-- Toolbar: filter destination ONLY (no zoom) -->
  <div id="toolbar">
    <strong>Target:</strong>
    <button onclick="setParams({drill_mode:1,lat:33.4484,lon:-112.0740,city_name:'phoenix'})">Phoenix</button>
    <button onclick="setParams({drill_mode:1,lat:32.2226,lon:-110.9747,city_name:'tucson'})">Tucson</button>
    <button onclick="setParams({drill_mode:1,lat:33.4152,lon:-111.8315,city_name:'mesa'})">Mesa</button>
    <button onclick="setParams({drill_mode:null,lat:null,lon:null,city_name:null})">Random</button>

    <span style="margin-left:14px"></span>
    <strong>Options:</strong>
    <!-- Explicit toggle: nofx=1 (muted) / nofx=0 (sound on) -->
    <button onclick="setParams({nofx: getParam('nofx')==='1' ? '0' : '1'})">Toggle Sounds</button>
    <button onclick="setParams({bad_day: getParam('bad_day') ? null : 1})">Busy Day</button>
    <button onclick="(function(){ const g=getParam('greenattacks'); const r=getParam('redattacks'); if(g){ setParams({greenattacks:null,redattacks:1}); } else if(r){ setParams({redattacks:null}); } else { setParams({greenattacks:1,redattacks:null}); } })()">Green/Red</button>
  </div>

  <center><div id="container1"></div></center>

  <!-- Fixed legend -->
  <div id="legendBox">
    <div><span class="sw" style="background:#0f0;"></span>Green: lower-severity / benign</div>
    <div><span class="sw" style="background:#f00;"></span>Red: higher-severity / malicious</div>
  </div>

  <div id="attackdiv"></div>
  <div id="aboutdiv"><i class="fa fa-question-circle fa-2x" onClick="about();"></i></div>
  <div id="ccdiv">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" />
    </a>
  </div>

  <div id="about">
    <h3>About IPew</h3>
    Attack maps are the <span style="font-family: monospace;">&lt;blink&gt;</span> tag of information security… (original text unchanged)<br/><br/>
    Check the <a target=_blank href="https://github.com/hrbrmstr/pewpew">GitHub repo</a> for full docs.
  </div>

  <!-- Arc hover tooltip -->
  <div id="tooltip"></div>

  <!-- keep the close anchor the original code uses -->
  <a href="#!" class="modal-close" title="Close this modal" data-dismiss="modal" data-close="Close">&times;</a>

  <!-- ==== IPEW SCRIPT (with drill_mode + city_name + default mute + arc tooltip + country FROM) ==== -->
  <script>
    attack_min = 100; attack_max = 2000;

    attack_type = [ "any port scan in a storm", "ssh brutish force", "Thought Leader Tweet",
                    "SYN FLOOD BA-BY", "Spotty", "Heartbleed Hotel", "Po_ODLE", "Sharknado",
                    "CORGI Attack", "Ping of DOOM", "Conficker", "Goldfinger", "SANDPAPER",
                    "SNAILshock", "Spaghetti RAT", "Driduplex" ];

    audio_type  = [ "starwars", "tng", "b5", "wargames", "pew", "galaga", "asteroids", "china", "timallen" ];

    $.extend({
      getUrlVars: function(){
        var vars=[], hash;
        var qPos = window.location.href.indexOf('?');
        var hashes = (qPos===-1)?[]:window.location.href.slice(qPos+1).split('&');
        for (var i=0; i<hashes.length; i++){
          hash = hashes[i].split('=');
          vars.push(hash[0]); vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){ return $.getUrlVars()[name]; }
    });

    var norse_mode   = $.getUrlVar('norse_mode');
    var bad_day      = $.getUrlVar('bad_day');
    var chatt_mode   = $.getUrlVar('chatt_mode');
    var china_mode   = $.getUrlVar('china_mode');
    var dprk_mode    = $.getUrlVar('dprk_mode');
    var employee_mode= $.getUrlVar('employee_mode');
    var employee_fname=$.getUrlVar('employee_fname');
    var employee_lname=$.getUrlVar('employee_lname');
    var origin       = $.getUrlVar('origin');
    var random_mode  = $.getUrlVar('random_mode');
    var tng          = $.getUrlVar('tng');
    var wargames     = $.getUrlVar('wargames');
    var b5           = $.getUrlVar('b5');
    var nofx         = $.getUrlVar('nofx');
    var pew          = $.getUrlVar('pew');
    var allfx        = $.getUrlVar('allfx');
    var galaga       = $.getUrlVar('galaga');
    var asteroids    = $.getUrlVar('asteroids');
    var china        = $.getUrlVar('china');
    var timallen     = $.getUrlVar('timallen');
    var drill_mode   = $.getUrlVar("drill_mode");
    var in_lat       = $.getUrlVar("lat");
    var in_lon       = $.getUrlVar("lon");
    var destination  = $.getUrlVar("destination");
    var greenattacks = $.getUrlVar("greenattacks");
    var redattacks   = $.getUrlVar("redattacks");
    var city_name    = $.getUrlVar("city_name"); // NEW

    // Default to muted if param is missing
    if (typeof nofx === 'undefined') { nofx = '1'; }

    if (typeof bad_day !== 'undefined'){ attack_min=200; attack_max=200; }

    // IPew map
    var map=new Datamap({
      scope:'world',
      element:document.getElementById('container1'),
      projection:'winkel3',
      fills:{ defaultFill:'black' },
      geographyConfig:{
        dataUrl:null, hideAntarctica:true, borderWidth:0.75, borderColor:'#4393c3',
        popupTemplate:function(geography,data){ return '<div class="hoverinfo" style="color:white;background:black">'+geography.properties.name+'</div>'; },
        popupOnHover:true, highlightOnHover:false, highlightFillColor:'black',
        highlightBorderColor:'rgba(250, 15, 160, 0.2)', highlightBorderWidth:2
      }
    });

    var centers=[], slatlong=[], cnlatlong=[];
    d3.tsv("country_centroids_primary.csv", function(data){ centers=data; });
    d3.csv("samplatlong.csv", function(data){ slatlong=data; });
    d3.csv("cnlatlong.csv", function(data){ cnlatlong=data; });

    // fixed queues
    function FixedQueue(size,initialValues){
      initialValues=(initialValues||[]);
      var queue=Array.apply(null,initialValues);
      queue.fixedSize=size; queue.push=FixedQueue.push; queue.splice=FixedQueue.splice; queue.unshift=FixedQueue.unshift;
      FixedQueue.trimTail.call(queue); return queue;
    }
    FixedQueue.trimHead=function(){ if(this.length<=this.fixedSize){return;} Array.prototype.splice.call(this,0,(this.length-this.fixedSize)); };
    FixedQueue.trimTail=function(){ if(this.length<=this.fixedSize){return;} Array.prototype.splice.call(this,this.fixedSize,(this.length-this.fixedSize)); };
    FixedQueue.wrapMethod=function(methodName,trimMethod){
      var wrapper=function(){ var method=Array.prototype[methodName]; var result=method.apply(this,arguments); trimMethod.call(this); return result; };
      return wrapper;
    };
    FixedQueue.push=FixedQueue.wrapMethod("push",FixedQueue.trimHead);
    FixedQueue.splice=FixedQueue.wrapMethod("splice",FixedQueue.trimTail);
    FixedQueue.unshift=FixedQueue.wrapMethod("unshift",FixedQueue.trimTail);

    var hits=FixedQueue(7,[]), boom=FixedQueue(7,[]), arcMeta=FixedQueue(7,[]);

    function getRandomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function getOctet(){ return Math.round(Math.random()*255); }
    function randomIP(){ return(getOctet()+'.'+getOctet()+'.'+getOctet()+'.'+getOctet()); }
    function getStroke(){ return Math.round(Math.random()*100); }
    function getDestination(){ return Math.round(Math.random()*100); }

    var tooltip = d3.select('#tooltip');

    function bindArcTooltips(){
      // rebind each time after arcs are drawn so indices match hits/arcMeta
      d3.select('#container1').selectAll('path.datamaps-arc')
        .on('mousemove', function(d,i){
          var m = arcMeta[i];
          if(!m) return;
          var ev = d3.event;
          tooltip.style('display','block')
                 .style('left', (ev.pageX + 12)+'px')
                 .style('top',  (ev.pageY + 12)+'px')
                 .html(
                   '<div class="ttl">'+m.attack+'</div>'+
                   'From: '+m.from+' ('+m.srcIP+')<br>'+
                   'To: '+m.to+' ('+m.dstIP+')'
                 );
        })
        .on('mouseout', function(){
          tooltip.style('display','none');
        });
    }

    var attacks={
      interval:getRandomInt(attack_min,attack_max),
      init:function(){ setTimeout(jQuery.proxy(this.getData,this), this.interval); },
      getData:function(){
        if(typeof norse_mode!=='undefined'){ return; }
        if(typeof random_mode!=='undefined'){ Math.floor((Math.random()*slatlong.length)); }

        var dst=Math.floor((Math.random()*slatlong.length));
        var src=Math.floor((Math.random()*slatlong.length));
        if(dst==src){ dst=src+1; if(dst>slatlong.length-1){ dst=src-1; } }

        // sounds — play only when nofx === '0'
        var snd_id="starwars";
        if(typeof tng!=='undefined') snd_id="tng";
        if(typeof b5!=='undefined') snd_id="b5";
        if(typeof wargames!=='undefined') snd_id="wargames";
        if(typeof pew!=='undefined') snd_id="pew";
        if(typeof galaga!=='undefined') snd_id="galaga";
        if(typeof asteroids!=='undefined') snd_id="asteroids";
        if(typeof china!=='undefined') snd_id="china";
        if(typeof timallen!=='undefined') snd_id="timallen";
        if(typeof allfx!=='undefined'){ snd_id=['starwars','tng','b5','wargames','pew','galaga','asteroids','china','timallen'][Math.floor((Math.random()*9))]; }
        if(nofx === '0'){ document.getElementById(snd_id).load(); document.getElementById(snd_id).play(); }

        var srclat=slatlong[src].lat, srclong=slatlong[src].long;
        var dstlat=slatlong[dst].lat, dstlong=slatlong[dst].long;
        var which_attack=["any port scan in a storm","ssh brutish force","Thought Leader Tweet","SYN FLOOD BA-BY","Spotty","Heartbleed Hotel","Po_ODLE","Sharknado","CORGI Attack","Ping of DOOM","Conficker","Goldfinger","SANDPAPER","SNAILshock","Spaghetti RAT","Driduplex"][Math.floor((Math.random()*16))];
        var srccountry=slatlong[src]["country"]; // two-letter ISO code (e.g., us, cn, ru)

        // variants (optional)
        if(typeof china_mode!=='undefined'){
          srclat=cnlatlong[src].lat; srclong=cnlatlong[src].long;
          if(cnlatlong[src].country=="chn"){ which_attack="ZOMGOSH CHINA!!!!!!"; }
          srccountry=cnlatlong[src]["country"];
        } else if(typeof dprk_mode!=='undefined'){
          srclat=39.0194; srclong=125.7381; which_attack="ZOMG NORTH KOREAZ!!!"; srccountry="kp";
        } else if(typeof chatt_mode!=='undefined'){
          srclat=35.0456297; srclong=-85.30968; which_attack="OMG NATION STATE CHATTANOOGA!!!"; srccountry="usa";
        } else if(typeof employee_mode!=='undefined'){
          if(typeof in_lat!=='undefined' && typeof in_lon!=='undefined'){ srclat=in_lat; srclong=in_lon; }
          which_attack="Former employee attack";
          if(typeof employee_fname!=='undefined' && typeof employee_lname!=='undefined'){ which_attack += ":"+employee_fname+" "+employee_lname; }
          srccountry="usa";
        } else if(typeof origin!=='undefined'){
          srccountry=origin.toUpperCase();
          var center_id=0;
          for(i=0;i<centers.length;i++){ center_id=i; if(centers[i].FIPS10===srccountry){ break; } }
          srccountry=origin.toLowerCase();
          srclat=centers[center_id].LAT; srclong=centers[center_id].LONG;
        }

        // Optional destination override by country code
        var attackdiv_slatlong;
        if(typeof destination!=='undefined' && getDestination()<80){
          var center_id=0, dstcountry=destination.toUpperCase();
          for(i=0;i<centers.length;i++){ center_id=i; if(centers[i].FIPS10===dstcountry){ break; } }
          dstcountry=destination.toLowerCase();
          attackdiv_slatlong=dstcountry;
          dstlat=centers[center_id].LAT; dstlong=centers[center_id].LONG;
        } else {
          attackdiv_slatlong=slatlong[dst]["country"];
        }

        // Color selection
        var strokeColor='green';
        if(typeof greenattacks!=='undefined'){ strokeColor='green'; }
        else if(typeof redattacks!=='undefined'){ strokeColor='red'; }
        else { strokeColor=(Math.round(Math.random()*100)<70)?'green':'red'; }

        // >>> Force destination to selected city when drill_mode is on
        if(typeof drill_mode!=='undefined' && in_lat && in_lon){
          dstlat=in_lat; dstlong=in_lon;
          attackdiv_slatlong = (typeof city_name!=='undefined' && city_name) ? city_name : 'target';
        }

        // Generate stable IPs per event for both log and tooltip
        var srcIP = randomIP();
        var dstIP = randomIP();

        if(!document.hidden){
          // push arc + metadata in lockstep so indices match
          hits.push({
            origin:{latitude:+srclat, longitude:+srclong},
            destination:{latitude:+dstlat, longitude:+dstlong}
          });
          arcMeta.push({
            from: (srccountry || '??').toUpperCase(),  // <- ALWAYS COUNTRY CODE IN UPPERCASE
            to: attackdiv_slatlong,
            attack: which_attack,
            srcIP: srcIP,
            dstIP: dstIP
          });

          map.arc(hits, {strokeWidth:2, strokeColor:strokeColor});
          bindArcTooltips(); // ensure handlers match the current arcs

          boom.push({ radius:7, latitude:+dstlat, longitude:+dstlong, fillOpacity:0.5, attk:which_attack });
          map.bubbles(boom, { popupTemplate:function(geo,data){ return '<div class="hoverinfo">'+data.attk+'</div>'; } });

          // log uses original srccountry (as-is), can also .toUpperCase() if you prefer
          $('#attackdiv').append(srccountry + " (" + srcIP + ") " +
            " <span style='color:red'>attacks</span> " + attackdiv_slatlong + " (" + dstIP + ") " +
            " <span style='color:steelblue'>(" + which_attack + ")</span> " + "<br/>");
          $('#attackdiv').animate({scrollTop: $('#attackdiv').prop('scrollHeight')}, 500);
        }

        this.interval=getRandomInt(attack_min,attack_max);
        this.init();
      }
    };

    attacks.init();
    d3.select(window).on('resize', function(){ location.reload(); });
  </script>
</body>
</html>
