<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Demo Dashboard Attack Map</title>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<style>
  body { margin:0; padding:0; background:#000; color:#fff; }

  #titlediv{
    font-family: monospace; text-align:center; font-size:48px;
    position:fixed; width:100%; height:50px; color:#fff; background:#000;
    padding:5px; top:0; z-index:10; overflow-y:auto;
  }

  #toolbar{
    position:fixed; left:0; right:0; top:55px; z-index:11;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:8px 10px; background:rgba(0,0,0,.85); border-bottom:1px solid #222;
    font-family: monospace; font-size:13px;
  }
  #toolbar button{
    cursor:pointer; background:#111; color:#eee; border:1px solid #333;
    padding:6px 10px; border-radius:6px;
  }
  #toolbar button:hover{ background:#151515; }

  #container1{ position:relative; width:100vw; height:100vh; }

  #attackdiv{
    font-family: monospace; font-size:10px;
    position:fixed; width:50%; height:110px; color:#fff; background:#000;
    padding:5px; bottom:0; z-index:10; overflow-y:auto; border-top:1px solid #222;
  }

  #legendBox{
    position:fixed; left:10px; bottom:130px; z-index:12;
    background:rgba(0,0,0,.85); border:1px solid #333; border-radius:6px;
    padding:6px 8px; color:#ddd; font-family:monospace; font-size:11px;
  }
  #legendBox .sw{ display:inline-block; width:12px; height:6px; border-radius:1px; margin-right:6px; }

  #tooltip{
    position:fixed; z-index:20; display:none; pointer-events:none;
    background:rgba(20,20,20,0.95); color:#eaeaea; border:1px solid #333; border-radius:6px;
    padding:8px 10px; font-family:monospace; font-size:11px; max-width:260px; line-height:1.35;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #tooltip .ttl{ font-weight:bold; color:#9fdcff; }

  #about{ display:none; }
  #aboutdiv{ text-align:right; width:100px; height:100px; top:0; right:0; position:fixed; padding:10px; color:#fff; z-index:12; }
  #ccdiv{ text-align:right; width:100px; height:20px; bottom:0; right:0; position:fixed; padding:5px; color:#fff; z-index:12; }
</style>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="jquery.simplemodal-1.4.4.js"></script>

<script>
  function about(){ $("#about").modal(); }
  function getParam(name){ try{ return new URL(window.location.href).searchParams.get(name);}catch(e){return null;} }
  function setParams(obj){
    const url=new URL(window.location.href);
    Object.keys(obj).forEach(k=>{
      const v=obj[k];
      if(v===null||v===undefined||v==='') url.searchParams.delete(k);
      else url.searchParams.set(k,v);
    });
    window.location.href=url.toString();
  }
</script>
</head>

<body>
  <div id="titlediv">Demo Dashboard Attack Map</div>

  <div id="toolbar">
    <strong>Target:</strong>
    <button onclick="setParams({drill_mode:1,lat:33.4484,lon:-112.0740,city_name:'phoenix'})">Phoenix</button>
    <button onclick="setParams({drill_mode:1,lat:32.2226,lon:-110.9747,city_name:'tucson'})">Tucson</button>
    <button onclick="setParams({drill_mode:1,lat:33.4152,lon:-111.8315,city_name:'mesa'})">Mesa</button>
    <button onclick="setParams({drill_mode:null,lat:null,lon:null,city_name:null})">Random</button>
    <span style="margin-left:14px"></span>
    <strong>Options:</strong>
    <button onclick="setParams({nofx: getParam('nofx')==='1' ? '0':'1'})">Toggle Sounds</button>
    <button onclick="setParams({bad_day: getParam('bad_day')? null:1})">Busy Day</button>
    <button onclick="(function(){const g=getParam('greenattacks');const r=getParam('redattacks');if(g){setParams({greenattacks:null,redattacks:1});}else if(r){setParams({redattacks:null});}else{setParams({greenattacks:1,redattacks:null});}})()">Green/Red</button>
  </div>

  <center><div id="container1"></div></center>

  <div id="legendBox">
    <div><span class="sw" style="background:#0f0;"></span>Green: lower-severity / benign</div>
    <div><span class="sw" style="background:#f00;"></span>Red: higher-severity / malicious</div>
  </div>

  <div id="attackdiv"></div>
  <div id="aboutdiv"><i class="fa fa-question-circle fa-2x" onClick="about();"></i></div>
  <div id="ccdiv"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
    <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a></div>
  <div id="about"><h3>About IPew</h3> Demo forkâ€¦</div>
  <div id="tooltip"></div>

<script>
attack_min=100;attack_max=2000;

$.extend({getUrlVars:function(){var vars=[],hash;var qPos=window.location.href.indexOf('?');var hashes=(qPos===-1)?[]:window.location.href.slice(qPos+1).split('&');for(var i=0;i<hashes.length;i++){hash=hashes[i].split('=');vars.push(hash[0]);vars[hash[0]]=hash[1];}return vars;},getUrlVar:function(name){return $.getUrlVars()[name];}});

var bad_day=$.getUrlVar('bad_day');
var nofx=$.getUrlVar('nofx');
var drill_mode=$.getUrlVar("drill_mode");
var in_lat=$.getUrlVar("lat");
var in_lon=$.getUrlVar("lon");
var destination=$.getUrlVar("destination");
var greenattacks=$.getUrlVar("greenattacks");
var redattacks=$.getUrlVar("redattacks");
var city_name=$.getUrlVar("city_name");

var rate=$.getUrlVar("rate");
var rate_min=$.getUrlVar("rate_min");
var rate_max=$.getUrlVar("rate_max");
var lingerParam=$.getUrlVar("linger");

if(typeof nofx==='undefined'){ nofx='1'; }
if(typeof bad_day!=='undefined'){ attack_min=200;attack_max=200; }
else{
  if(rate){ attack_min=attack_max=Math.max(200,parseInt(rate,10)||1200); }
  else{
    var rmin=Math.max(300,parseInt(rate_min,10)||900);
    var rmax=Math.max(rmin+200,parseInt(rate_max,10)||1600);
    attack_min=rmin;attack_max=rmax;
  }
}
var LINGER=Math.max(5,parseInt(lingerParam,10)||30);

var map=new Datamap({scope:'world',element:document.getElementById('container1'),projection:'winkel3',fills:{defaultFill:'black'},geographyConfig:{hideAntarctica:true,borderWidth:0.75,borderColor:'#4393c3',popupOnHover:true,highlightOnHover:false}});

var centers=[],slatlong=[],cnlatlong=[];
d3.tsv("country_centroids_primary.csv",function(d){centers=d;});
d3.csv("samplatlong.csv",function(d){slatlong=d;});
d3.csv("cnlatlong.csv",function(d){cnlatlong=d;});

function FixedQueue(size,iv){iv=(iv||[]);var q=Array.apply(null,iv);q.fixedSize=size;q.push=FixedQueue.push;q.splice=FixedQueue.splice;q.unshift=FixedQueue.unshift;FixedQueue.trimTail.call(q);return q;}
FixedQueue.trimHead=function(){if(this.length<=this.fixedSize){return;}Array.prototype.splice.call(this,0,(this.length-this.fixedSize));};
FixedQueue.trimTail=function(){if(this.length<=this.fixedSize){return;}Array.prototype.splice.call(this,this.fixedSize,(this.length-this.fixedSize));};
FixedQueue.wrapMethod=function(m,tm){var w=function(){var method=Array.prototype[m];var result=method.apply(this,arguments);tm.call(this);return result;};return w;};
FixedQueue.push=FixedQueue.wrapMethod("push",FixedQueue.trimHead);
FixedQueue.splice=FixedQueue.wrapMethod("splice",FixedQueue.trimTail);
FixedQueue.unshift=FixedQueue.wrapMethod("unshift",FixedQueue.trimTail);

var hits=FixedQueue(LINGER,[]),boom=FixedQueue(Math.min(LINGER,50),[]),arcMeta=FixedQueue(LINGER,[]);
var tooltip=d3.select('#tooltip');

function bindHoverFor(el,meta){
  d3.select(el).on('mousemove',function(){
    var ev=d3.event;
    tooltip.style('display','block').style('left',(ev.pageX+12)+'px').style('top',(ev.pageY+12)+'px')
      .html('<div class="ttl">'+meta.attack+'</div>'+'From: '+meta.from+' ('+meta.srcIP+')<br>'+'To: '+meta.to+' ('+meta.dstIP+')');
  }).on('mouseout',function(){tooltip.style('display','none');});
}

function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function getOctet(){return Math.round(Math.random()*255);}
function randomIP(){return(getOctet()+'.'+getOctet()+'.'+getOctet()+'.'+getOctet());}
function getStroke(){return Math.round(Math.random()*100);}

var attacks={interval:getRandomInt(attack_min,attack_max),init:function(){setTimeout(jQuery.proxy(this.getData,this),this.interval);},getData:function(){
  var dst=Math.floor((Math.random()*slatlong.length));
  var src=Math.floor((Math.random()*slatlong.length));
  if(dst==src){dst=src+1;if(dst>slatlong.length-1){dst=src-1;}}

  if(nofx==='0'){document.getElementById('starwars').load();document.getElementById('starwars').play();}

  var srclat=slatlong[src].lat,srclong=slatlong[src].long;
  var dstlat=slatlong[dst].lat,dstlong=slatlong[dst].long;
  var which_attack="Attack "+Math.floor(Math.random()*100);
  var srccountry=(slatlong[src]["country"]||'??').toUpperCase();

  var attackdiv_slatlong=(slatlong[dst]["country"]||'??');
  if(typeof drill_mode!=='undefined' && in_lat && in_lon){dstlat=in_lat;dstlong=in_lon;attackdiv_slatlong=(city_name||'target');}

  var strokeColor=(typeof greenattacks!=='undefined')?'green':(typeof redattacks!=='undefined')?'red':(getStroke()<70?'green':'red');

  var srcIP=randomIP(),dstIP=randomIP();
  if(!document.hidden){
    var newHit={origin:{latitude:+srclat,longitude:+srclong},destination:{latitude:+dstlat,longitude:+dstlong}};
    hits.push(newHit);
    var meta={from:srccountry,to:attackdiv_slatlong,attack:which_attack,srcIP:srcIP,dstIP:dstIP};
    arcMeta.push(meta);
    map.arc([newHit],{strokeWidth:2,strokeColor:strokeColor});
    var sel=d3.select('#container1').selectAll('path.datamaps-arc');var nodes=sel[0];
    if(nodes&&nodes.length){var last=nodes[nodes.length-1];last.__meta=meta;bindHoverFor(last,meta);}
    if(nodes&&nodes.length>hits.fixedSize){var oldest=nodes[0];if(oldest&&oldest.parentNode){oldest.parentNode.removeChild(oldest);}}
    boom.push({radius:7,latitude:+dstlat,longitude:+dstlong,fillOpacity:0.5,attk:which_attack});
    map.bubbles(boom,{popupTemplate:function(geo,d){return '<div class="hoverinfo">'+d.attk+'</div>';}});

    $('#attackdiv').append(srccountry+" ("+srcIP+") "+"<span style='color:red'>attacks</span> "+attackdiv_slatlong+" ("+dstIP+") "+"<span style='color:steelblue'>("+which_attack+")</span><br/>");
    $('#attackdiv').animate({scrollTop:$('#attackdiv').prop('scrollHeight')},500);
  }
  this.interval=getRandomInt(attack_min,attack_max);this.init();
}};
attacks.init();
d3.select(window).on('resize',function(){location.reload();});
</script>
</body>
</html>
