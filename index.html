<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>IPew Attack Map — AZ DES</title>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<style>
  body { margin:0; padding:0; background:#000; color:#fff; }
  #titlediv {
    font-family: monospace; text-align:center; font-size:48px;
    position:fixed; width:100%; height:50px; color:#fff; background:#000;
    padding:5px; top:0; z-index:10; overflow-y:auto;
  }
  /* Toolbar for zoom + options */
  #toolbar{
    position:fixed; left:0; right:0; top:55px; z-index:11;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:8px 10px; background:rgba(0,0,0,.85); border-bottom:1px solid #222;
    font-family: monospace; font-size:13px;
  }
  #toolbar button{
    cursor:pointer; background:#111; color:#eee; border:1px solid #333;
    padding:6px 10px; border-radius:6px;
  }
  #toolbar button:hover{ background:#151515; }
  #container1 { position:relative; width:100vw; height:100vh; max-width:100%; max-height:100%; }
  #attackdiv {
    font-family: monospace; font-size:10px;
    position:fixed; width:50%; height:110px; color:#fff; background:#000;
    padding:5px; bottom:0; z-index:12; overflow-y:auto; border-top:1px solid #222;
  }
  /* Legend styling */
  #legend { padding:4px 6px; border-top:1px solid #333; margin-top:4px; color:#aaa; font-size:10px; }
  #legend span { display:inline-block; width:12px; height:5px; border-radius:1px; margin-right:4px; }
  #about { display:none; }
  #aboutdiv { text-align:right; width:100px; height:100px; top:0; right:0; position:fixed; padding:10px; color:#fff; z-index:12; }
  #ccdiv { text-align:right; width:100px; height:20px; bottom:0; right:0; position:fixed; padding:5px; color:#fff; z-index:12; }
</style>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="jquery.simplemodal-1.4.4.js"></script>
<script>
function about(){ $("#about").modal(); }
/* Helpers to read and set URL params */
function getParam(name){ var url=new URL(window.location.href); return url.searchParams.get(name); }
function setParams(obj){
  var url=new URL(window.location.href);
  Object.keys(obj).forEach(function(k){
    var v=obj[k];
    if(v===null||v===undefined||v==='') url.searchParams.delete(k);
    else url.searchParams.set(k,v);
  });
  if(!url.searchParams.get('org_name')) url.searchParams.set('org_name','AZ%20DES');
  window.location.href=url.toString();
}
</script>
</head>
<body>
  <!-- sounds -->
  <audio id="starwars" src="Blaster-Solo.wav" preload="auto"></audio>
  <audio id="tng" src="tng_torpedo_clean.mp3" preload="auto"></audio>
  <audio id="b5" src="B5-interceptor1.wav" preload="auto"></audio>
  <audio id="wargames" src="WarGames-KeyPress.wav" preload="auto"></audio>
  <audio id="pew" src="pew.mp3" preload="auto"></audio>
  <audio id="galaga" src="shot_sound.mp3" preload="auto"></audio>
  <audio id="asteroids" src="asteroids.mp3" preload="auto"></audio>
  <audio id="china" src="china.mp3" preload="auto"></audio>
  <audio id="timallen" src="timallen.wav" preload="auto"></audio>

  <div id="titlediv">IPew Attack Map</div>
  <!-- Toolbar: Zoom and toggles -->
  <div id="toolbar">
    <strong>Zoom:</strong>
    <button id="zoom-phx">Phoenix</button>
    <button id="zoom-tus">Tucson</button>
    <button id="zoom-mesa">Mesa</button>
    <button id="zoom-reset">Reset</button>
    <span style="margin-left:12px;"></span>
    <strong>Options:</strong>
    <button onclick="setParams({bad_day: getParam('bad_day')? null:1})">Busy Day</button>
    <button onclick="setParams({nofx: getParam('nofx')? null:1})">Toggle Sounds</button>
    <button onclick="(function(){ var g=getParam('greenattacks'), r=getParam('redattacks'); if(g){ setParams({greenattacks:null,redattacks:1}); } else if(r){ setParams({redattacks:null}); } else { setParams({greenattacks:1,redattacks:null}); } })()">Green/Red</button>
  </div>

  <center><div id="container1"></div></center>
  <div id="attackdiv">
    <div id="log"></div>
    <div id="legend">
      <span style="background:#0f0;"></span>Green = Low‑severity/benign<br>
      <span style="background:#f00;"></span>Red = High‑severity/malicious
    </div>
  </div>
  <div id="aboutdiv"><i class="fa fa-question-circle fa-2x" onClick="about();"></i></div>
  <div id="ccdiv">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" />
    </a>
  </div>
  <div id="about">
    <h3>About this demo</h3>
    <p>This IPew‑style attack map is tailored for AZ DES leadership demos. Using <code>drill_mode=1</code> with latitude/longitude concentrates all arcs on a chosen Arizona location. It’s an executive‑awareness visualization; colours and volumes are illustrative only.</p>
    <p>Use URL parameters such as <code>bad_day=1</code> for higher activity, <code>nofx=1</code> to mute pew‑pew sounds, and <code>greenattacks</code>/<code>redattacks</code> to force arc colours.</p>
    <p>For code details see <a href="https://github.com/hrbrmstr/pewpew" target="_blank">hrbrmstr/pewpew</a>.</p>
  </div>
  <a href="#!" class="modal-close" title="Close this modal" data-dismiss="modal" data-close="Close">&times;</a>

  <script>
    /* ----- Original IPew script (shortened for clarity) ----- */
    attack_min=100; attack_max=2000;
    attack_type=[ "any port scan in a storm","ssh brutish force","Thought Leader Tweet","SYN FLOOD BA-BY","Spotty","Heartbleed Hotel","Po_ODLE","Sharknado","CORGI Attack","Ping of DOOM","Conficker","Goldfinger","SANDPAPER","SNAILshock","Spaghetti RAT","Driduplex" ];
    audio_type=[ "starwars","tng","b5","wargames","pew","galaga","asteroids","china","timallen" ];
    $.extend({
      getUrlVars:function(){ var vars=[],hash; var qPos=window.location.href.indexOf('?'); var hashes=(qPos===-1)?[]:window.location.href.slice(qPos+1).split('&'); for(var i=0;i<hashes.length;i++){ hash=hashes[i].split('='); vars.push(hash[0]); vars[hash[0]]=hash[1]; } return vars; },
      getUrlVar:function(name){ return $.getUrlVars()[name]; }
    });

    // reading URL params
    var norse_mode = $.getUrlVar('norse_mode');
    var bad_day    = $.getUrlVar('bad_day');
    var org_name   = $.getUrlVar('org_name');
    var greenattacks  = $.getUrlVar('greenattacks');
    var redattacks    = $.getUrlVar('redattacks');
    var nofx      = $.getUrlVar('nofx');
    var drill_mode = $.getUrlVar('drill_mode');
    var in_lat    = $.getUrlVar('lat');
    var in_lon    = $.getUrlVar('lon');

    snd_id = "starwars";
    if      ($.getUrlVar('tng')      !== undefined) snd_id="tng";
    else if ($.getUrlVar('b5')       !== undefined) snd_id="b5";
    else if ($.getUrlVar('wargames') !== undefined) snd_id="wargames";
    else if ($.getUrlVar('pew')      !== undefined) snd_id="pew";
    else if ($.getUrlVar('galaga')   !== undefined) snd_id="galaga";
    else if ($.getUrlVar('asteroids')!== undefined) snd_id="asteroids";
    else if ($.getUrlVar('china')    !== undefined) snd_id="china";
    else if ($.getUrlVar('timallen') !== undefined) snd_id="timallen";

    if(bad_day!==undefined){ attack_min=200; attack_max=200; }
    if(org_name!==undefined){ $("#titlediv").text(decodeURI(org_name) + " IPew Attack Map").html(); }

    function FixedQueue(size,initialValues){initialValues=(initialValues||[]);var queue=Array.apply(null,initialValues);queue.fixedSize=size;queue.push=FixedQueue.push;queue.splice=FixedQueue.splice;queue.unshift=FixedQueue.unshift;FixedQueue.trimTail.call(queue);return queue;}
    FixedQueue.trimHead=function(){ if(this.length<=this.fixedSize){return;} Array.prototype.splice.call(this,0,(this.length-this.fixedSize)); };
    FixedQueue.trimTail=function(){ if(this.length<=this.fixedSize){return;} Array.prototype.splice.call(this,this.fixedSize,(this.length-this.fixedSize)); };
    FixedQueue.wrapMethod=function(methodName,trimMethod){ var wrapper=function(){ var method=Array.prototype[methodName]; var result=method.apply(this,arguments); trimMethod.call(this); return result; }; return wrapper; };
    FixedQueue.push=FixedQueue.wrapMethod("push",FixedQueue.trimHead);
    FixedQueue.splice=FixedQueue.wrapMethod("splice",FixedQueue.trimTail);
    FixedQueue.unshift=FixedQueue.wrapMethod("unshift",FixedQueue.trimTail);

    function rand(min,max){ return Math.random()*(max-min)+min; }
    function getRandomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function getOctet(){ return Math.round(Math.random()*255); }
    function randomIP(){ return(getOctet()+'.'+getOctet()+'.'+getOctet()+'.'+getOctet()); }
    function getStroke(){ return Math.round(Math.random()*100); }

    var map = new Datamap({
      scope:'world',
      element:document.getElementById('container1'),
      projection:'winkel3',
      fills:{ defaultFill:'black' },
      geographyConfig:{
        hideAntarctica:true,
        borderWidth:0.75,
        borderColor:'#4393c3',
        popupTemplate:function(geography,data){ return '<div class="hoverinfo" style="color:white;background:black">'+geography.properties.name+'</div>'; },
        popupOnHover:true, highlightOnHover:false, highlightFillColor:'black',
        highlightBorderColor:'rgba(250, 15, 160, 0.2)', highlightBorderWidth:2
      }
    });

    var centers=[]; var slatlong=[]; var cnlatlong=[];
    d3.tsv("country_centroids_primary.csv", function(data){ centers=data; });
    d3.csv("samplatlong.csv", function(data){ slatlong=data; });
    d3.csv("cnlatlong.csv", function(data){ cnlatlong=data; });

    var hits=FixedQueue(7,[]); var boom=FixedQueue(7,[]);

    var attacks = {
      interval:getRandomInt(attack_min,attack_max),
      init:function(){ setTimeout(jQuery.proxy(this.getData,this), this.interval); },
      getData:function(){
        if(norse_mode!==undefined){ return; }
        dst = Math.floor((Math.random()*slatlong.length));
        src = Math.floor((Math.random()*slatlong.length));
        if(dst==src){ dst=src+1; if(dst>slatlong.length-1){ dst=src-1; } }
        if($.getUrlVar('allfx')!==undefined){ snd_id = audio_type[Math.floor((Math.random()*audio_type.length))]; }
        if(nofx===undefined){ document.getElementById(snd_id).load(); document.getElementById(snd_id).play(); }

        var srclat=slatlong[src].lat, srclong=slatlong[src].long;
        var dstlat=slatlong[dst].lat, dstlong=slatlong[dst].long;
        which_attack=attack_type[Math.floor((Math.random()*attack_type.length))];
        var srccountry=slatlong[src]["country"];
        /* (other modes trimmed for brevity) */

        if(greenattacks!==undefined){ strokeColor='green'; }
        else if(redattacks!==undefined){ strokeColor='red'; }
        else { strokeColor=(getStroke()<70)?'green':'red'; }

        if(drill_mode!==undefined){ dstlat=in_lat; dstlong=in_lon; }

        hits.push({ origin:{latitude:+srclat, longitude:+srclong}, destination:{latitude:+dstlat, longitude:+dstlong} });
        map.arc(hits, {strokeWidth:2, strokeColor:strokeColor});
        boom.push({ radius:7, latitude:+dstlat, longitude:+dstlong, fillOpacity:0.5, attk:which_attack });
        map.bubbles(boom, { popupTemplate:function(geo,data){ return '<div class="hoverinfo">'+data.attk+'</div>'; } });
        $('#log').append(srccountry + " (" + randomIP() + ") attacks " + slatlong[dst]["country"] + " (" + randomIP() + ") <span style='color:steelblue'>(" + which_attack + ")</span><br/>");
        $('#attackdiv').animate({scrollTop: $('#attackdiv').prop('scrollHeight')}, 500);
        this.interval=getRandomInt(attack_min,attack_max);
        this.init();
      }
    };
    attacks.init();
    d3.select(window).on('resize', function(){ location.reload(); });

    /* ----- Zoom/pan: wait for map SVG then attach ----- */
    (function enableZoom(){
      function tryEnable(){
        var svg = d3.select('#container1 svg');
        if(svg.empty()){ return setTimeout(tryEnable, 150); }
        var root = svg.select('g');
        var width  = svg.node().clientWidth  || parseInt(svg.attr('width'))  || window.innerWidth;
        var height = svg.node().clientHeight || parseInt(svg.attr('height')) || window.innerHeight;
        var zoom = d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([1, 16])
          .on('zoom', function(){ var e=d3.event; root.attr('transform','translate('+e.translate+') scale('+e.scale+')'); });
        svg.call(zoom).on('dblclick.zoom', null);
        function project(lon, lat){ return map.projection([lon, lat]); }
        function zoomTo(lon, lat, k){
          var p = project(lon, lat), tx = (width/2) - k*p[0], ty = (height/2) - k*p[1];
          zoom.translate([tx, ty]).scale(k);
          root.transition().duration(700).attr('transform','translate('+tx+','+ty+') scale('+k+')');
        }
        var PHX = { lon:-112.0740, lat:33.4484, k:8.5 };
        var TUS = { lon:-110.9747, lat:32.2226, k:9.5 };
        var MESA= { lon:-111.8315, lat:33.4152, k:10.0 };
        document.getElementById('zoom-phx').onclick  = function(){ zoomTo(PHX.lon, PHX.lat, PHX.k); };
        document.getElementById('zoom-tus').onclick  = function(){ zoomTo(TUS.lon, TUS.lat, TUS.k); };
        document.getElementById('zoom-mesa').onclick = function(){ zoomTo(MESA.lon, MESA.lat, MESA.k); };
        document.getElementById('zoom-reset').onclick= function(){ zoomTo(-98, 38, 1.2); };
        // Auto-zoom if drill_mode present
        if(drill_mode!==undefined && in_lat && in_lon){
          setTimeout(function(){ zoomTo(parseFloat(in_lon), parseFloat(in_lat), 6.5); }, 1200);
        }
      }
      tryEnable();
    })();
  </script>
</body>
</html>
