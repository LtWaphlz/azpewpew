<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>AZ DES • IPew Attack Map</title>
<style>
  body { margin:0; padding:0; background:#000; color:#fff; font-family: monospace; }

  #titlediv {
    text-align:center; font-size:28px; position:fixed; left:0; right:0; top:0;
    padding:8px 12px; background:#000; z-index:10; border-bottom:1px solid #222;
  }

  /* NEW: simple control bar */
  #toolbar {
    position:fixed; left:0; right:0; top:48px; z-index:11;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:8px 10px; background:rgba(0,0,0,.85); border-bottom:1px solid #222;
  }
  #toolbar button, #toolbar .toggle {
    font-family:monospace; font-size:13px; cursor:pointer;
    background:#111; color:#eee; border:1px solid #333; padding:6px 10px; border-radius:6px;
  }
  #toolbar button:hover, #toolbar .toggle:hover { background:#151515; }
  #toolbar .active { background:#1c2a22; border-color:#2f6; color:#bfffd3; }
  #toolbar .danger { background:#2a1c1c; border-color:#f44; color:#ffd0d0; }

  #attackdiv {
    font-size:10px; position:fixed; left:0; width:52%; height:110px; bottom:0;
    padding:6px; overflow-y:auto; background:#000; border-top:1px solid #222; z-index:10;
  }
  #container1 { position:fixed; inset:0; }
  #aboutdiv { position:fixed; right:6px; top:6px; z-index:12; color:#fff; }
  #ccdiv { position:fixed; right:6px; bottom:6px; z-index:12; color:#fff; }

  /* Modal styles (unchanged) */
  #about { display:none; }
  #simplemodal-overlay { background-color:#000; }
  #simplemodal-container {height:460px; width:600px; color:#bbb; background:#333; border:4px solid #444; padding:12px;}
  #simplemodal-container .simplemodal-data {padding:8px;}
  #simplemodal-container code {background:#141414; border-left:3px solid #65B43D; color:#bbb; display:block; font-size:12px; margin-bottom:12px; padding:4px 6px 6px;}
  #simplemodal-container a {color:#ddd;}
  #simplemodal-container a.modalCloseImg {background:url(x.png) no-repeat; width:25px; height:29px; display:inline; z-index:3200; position:absolute; top:-15px; right:-18px; cursor:pointer;}
  #simplemodal-container h3 {color:#84b8d9;}
</style>

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="jquery.simplemodal-1.4.4.js"></script>

<script>
function about(){ $("#about").modal(); }
</script>
</head>

<body>

  <!-- Sounds (unchanged; toggled by URL param) -->
  <audio id="starwars" src="Blaster-Solo.wav" preload="auto"></audio>
  <audio id="tng" src="tng_torpedo_clean.mp3" preload="auto"></audio>
  <audio id="b5" src="B5-interceptor1.wav" preload="auto"></audio>
  <audio id="wargames" src="WarGames-KeyPress.wav" preload="auto"></audio>
  <audio id="pew" src="pew.mp3" preload="auto"></audio>
  <audio id="galaga" src="shot_sound.mp3" preload="auto"></audio>
  <audio id="asteroids" src="asteroids.mp3" preload="auto"></audio>
  <audio id="china" src="china.mp3" preload="auto"></audio>
  <audio id="timallen" src="timallen.wav" preload="auto"></audio>

  <div id="titlediv">AZ DES — IPew Attack Map</div>

  <!-- NEW toolbar (no-code toggles) -->
  <div id="toolbar">
    <span>Target:</span>
    <button id="btn-phx">Phoenix</button>
    <button id="btn-tus">Tucson</button>
    <button id="btn-mesa">Mesa</button>
    <button id="btn-random">Random</button>

    <span style="margin-left:14px">Options:</span>
    <button id="btn-busy" class="toggle">Busy day</button>
    <button id="btn-snd" class="toggle">Sounds</button>
    <button id="btn-colors" class="toggle">Green/Red</button>
  </div>

  <center><div id="container1"></div></center>
  <div id="attackdiv"></div>
  <div id="aboutdiv"><i class="fa fa-question-circle fa-2x" onClick="about();"></i></div>

  <div id="ccdiv">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" />
    </a>
  </div>

  <div id="about">
    <h3>About IPew</h3>
    Attack maps are the <span style="font-family: monospace;">&lt;blink&gt;</span> tag of infosec… (unchanged text)
    <br/><br/>See the <a target=_blank href="https://github.com/hrbrmstr/pewpew">GitHub repository</a> for full docs.
  </div>

  <!-- Use Hash-Bang to maintain scroll position when closing modal -->
  <a href="#!" class="modal-close" title="Close this modal"
      data-dismiss="modal" data-close="Close">&times;</a>

  <script>
    /* ---------- Helper: URL param tools ---------- */
    $.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var qPos = window.location.href.indexOf('?');
        var hashes = (qPos===-1) ? [] : window.location.href.slice(qPos + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
          hash = hashes[i].split('=');
          vars.push(hash[0]); vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){ return $.getUrlVars()[name]; }
    });
    function updateParams(obj){
      const url = new URL(window.location.href);
      Object.keys(obj).forEach(k=>{
        const v = obj[k];
        if (v===null || v===undefined || v==='') url.searchParams.delete(k);
        else url.searchParams.set(k, v);
      });
      // ensure org name & title
      if (!url.searchParams.get('org_name')) url.searchParams.set('org_name','AZ%20DES');
      window.location.href = url.toString();
    }

    /* ---------- Read initial params ---------- */
    var norse_mode = $.getUrlVar('norse_mode');
    var bad_day = $.getUrlVar('bad_day');
    var org_name = $.getUrlVar('org_name');
    var chatt_mode = $.getUrlVar('chatt_mode');
    var china_mode = $.getUrlVar('china_mode');
    var dprk_mode = $.getUrlVar('dprk_mode');
    var employee_mode = $.getUrlVar('employee_mode');
    var employee_fname = $.getUrlVar('employee_fname');
    var employee_lname = $.getUrlVar('employee_lname');
    var origin = $.getUrlVar('origin');
    var random_mode = $.getUrlVar('random_mode');
    var tng = $.getUrlVar('tng');
    var wargames = $.getUrlVar('wargames');
    var b5 = $.getUrlVar('b5');
    var nofx = $.getUrlVar('nofx');
    var pew = $.getUrlVar('pew');
    var allfx = $.getUrlVar('allfx');
    var galaga = $.getUrlVar('galaga');
    var asteroids = $.getUrlVar('asteroids');
    var china = $.getUrlVar('china');
    var timallen = $.getUrlVar('timallen');
    var drill_mode = $.getUrlVar('drill_mode');
    var in_lat = $.getUrlVar('lat');
    var in_lon = $.getUrlVar('lon');
    var destination = $.getUrlVar('destination');
    var greenattacks = $.getUrlVar('greenattacks');
    var redattacks = $.getUrlVar('redattacks');

    // choose a default sound if none specified
    snd_id = "starwars";
    if (typeof tng      !== 'undefined') snd_id = "tng";
    if (typeof b5       !== 'undefined') snd_id = "b5";
    if (typeof wargames !== 'undefined') snd_id = "wargames";
    if (typeof pew      !== 'undefined') snd_id = "pew";
    if (typeof galaga   !== 'undefined') snd_id = "galaga";
    if (typeof asteroids!== 'undefined') snd_id = "asteroids";
    if (typeof china    !== 'undefined') snd_id = "china";
    if (typeof timallen !== 'undefined') snd_id = "timallen";

    // activity level
    if (typeof bad_day !== 'undefined') { attack_min=200; attack_max=200; }
    if (typeof org_name !== 'undefined') { $("#titlediv").text(decodeURI(org_name) + " — IPew Attack Map").html(); }

    /* ---------- NEW toolbar wiring ---------- */
    const cities = {
      phoenix: {lat:33.4484, lon:-112.0740},
      tucson:  {lat:32.2226, lon:-110.9747},
      mesa:    {lat:33.4152, lon:-111.8315}
    };
    function setCity(name){
      if (name==='random'){
        updateParams({ drill_mode:null, lat:null, lon:null });
        return;
      }
      const c = cities[name];
      updateParams({ drill_mode:1, lat:c.lat, lon:c.lon, org_name: 'AZ%20DES' });
    }
    function toggleBusy(){
      const isOn = $.getUrlVar('bad_day') !== undefined;
      updateParams({ bad_day: isOn ? null : 1 });
    }
    function toggleSound(){
      const muted = $.getUrlVar('nofx') !== undefined;
      updateParams({ nofx: muted ? null : 1 });
    }
    function toggleColors(){
      // cycle: mixed -> green only -> red only -> mixed
      if ($.getUrlVar('greenattacks') !== undefined) {
        updateParams({ greenattacks:null, redattacks:1 });
      } else if ($.getUrlVar('redattacks') !== undefined) {
        updateParams({ redattacks:null });
      } else {
        updateParams({ greenattacks:1, redattacks:null });
      }
    }

    // paint initial toolbar state
    function paintToolbar(){
      const lat = $.getUrlVar('lat'), lon = $.getUrlVar('lon');
      const dm  = $.getUrlVar('drill_mode');
      const cityFromParams =
        (dm!==undefined && lat && lon) &&
        Object.keys(cities).find(k => String(cities[k].lat)==String(lat) && String(cities[k].lon)==String(lon));

      $('#btn-phx').toggleClass('active', cityFromParams==='phoenix');
      $('#btn-tus').toggleClass('active', cityFromParams==='tucson');
      $('#btn-mesa').toggleClass('active', cityFromParams==='mesa');
      $('#btn-random').toggleClass('active', !cityFromParams);

      $('#btn-busy').toggleClass('active', $.getUrlVar('bad_day') !== undefined);
      $('#btn-snd').toggleClass('danger', $.getUrlVar('nofx') !== undefined).text( ($.getUrlVar('nofx')!==undefined) ? 'Sounds OFF' : 'Sounds ON' );
      if ($.getUrlVar('greenattacks') !== undefined) $('#btn-colors').text('Green only').addClass('active');
      else if ($.getUrlVar('redattacks') !== undefined) $('#btn-colors').text('Red only').addClass('active');
      else $('#btn-colors').text('Green/Red').removeClass('active');
    }
    $(function(){
      $('#btn-phx').on('click', ()=>setCity('phoenix'));
      $('#btn-tus').on('click', ()=>setCity('tucson'));
      $('#btn-mesa').on('click', ()=>setCity('mesa'));
      $('#btn-random').on('click', ()=>setCity('random'));
      $('#btn-busy').on('click', toggleBusy);
      $('#btn-snd').on('click', toggleSound);
      $('#btn-colors').on('click', toggleColors);
      paintToolbar();
    });

    /* ---------- Original IPew setup (unchanged logic) ---------- */

    // default timer range for random draw
